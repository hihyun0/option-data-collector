name: Option Data Fetch

on:
  schedule:
    # GitHub Actions cron = UTC
    - cron: "8 * * * *"
    - cron: "38 * * * *"
    - cron: "41 7 * * *"    # 16:41 KST (ë§Œê¸° ë³´í˜¸ ìŠ¤ëƒ…ìƒ·)
  workflow_dispatch:

concurrency:
  group: option-data-fetch
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run fetcher
        run: python fetcher.py

      - name: Check for changes
        id: git_status
        run: |
          # database í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„± (ë°©ì–´ì  ì½”ë“œ)
          mkdir -p database
          
          # git addë¥¼ ë¨¼ì € í•´ì„œ untracked íŒŒì¼ì„ staging ì˜ì—­ìœ¼ë¡œ ì˜¬ë¦¼
          git add database/
          
          # staging ì˜ì—­ì— ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            print("No changes detected in database.")
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            print("Changes detected in database.")
          fi

      - name: Upload live.db artifact
        # ìœ„ ë‹¨ê³„ì—ì„œ changed=trueì¼ ë•Œë§Œ ì‹¤í–‰
        if: steps.git_status.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: live-db
          path: database/
          retention-days: 5

      - name: Commit & push data
        if: steps.git_status.outputs.changed == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          # ì´ë¯¸ ìœ„ì—ì„œ git addë¥¼ í–ˆìœ¼ë¯€ë¡œ ë°”ë¡œ ì»¤ë°‹
          git commit -m "auto: update option data with greeks"
          git pushh

      - name: Notify Discord (success)
        if: success() && steps.git_status.outputs.changed == 'true'
        run: |
          UTC_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          KST_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"âœ… **ì˜µì…˜ ë°ì´í„° ê°±ì‹  ì™„ë£Œ**\nâ° KST: ${KST_TIME}\nâ° UTC: ${UTC_TIME}\nğŸ“‚ ${{ github.repository }}\"
            }" \
            "${{ secrets.DISCORD_WEBHOOK }}"

      - name: Notify Discord (failure)
        if: failure()
        run: |
          UTC_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          KST_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ğŸš¨ **ì˜µì…˜ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨**\nâ° KST: ${KST_TIME}\nâ° UTC: ${UTC_TIME}\nğŸ”— https://github.com/${{ github.repository }}/actions\"
            }" \
            "${{ secrets.DISCORD_WEBHOOK }}"





      
